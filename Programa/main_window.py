# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'main_window.ui'
#
# Created by: PyQt5 UI code generator 5.15.5
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.


from PySide2 import QtCore, QtGui, QtWidgets
from map_painter import MapPainter
from core import *

class Ui_MainWindow(object):
    def setupUi(self, MainWindow):
        MainWindow.setObjectName("MainWindow")
        MainWindow.resize(1176, 782)
        self.centralwidget = QtWidgets.QWidget(MainWindow)
        self.centralwidget.setObjectName("centralwidget")

        self.label = QtWidgets.QLabel(self.centralwidget)
        self.label.setGeometry(QtCore.QRect(0, -10, 1011, 751))
        self.label.setText("")
        self.label.setPixmap(QtGui.QPixmap("assets/map.png"))
        self.label.setScaledContents(True)
        self.label.setObjectName("label")
        self.label.mouseReleaseEvent = self.mouseReleased

        MainWindow.setCentralWidget(self.centralwidget)
        self.menubar = QtWidgets.QMenuBar(MainWindow)
        self.menubar.setGeometry(QtCore.QRect(0, 0, 1176, 21))
        self.menubar.setObjectName("menubar")
        MainWindow.setMenuBar(self.menubar)
        self.statusbar = QtWidgets.QStatusBar(MainWindow)
        self.statusbar.setObjectName("statusbar")
        MainWindow.setStatusBar(self.statusbar)

        MainWindow.event

        self.retranslateUi(MainWindow)
        QtCore.QMetaObject.connectSlotsByName(MainWindow)

        self.map_painter = MapPainter('assets/map.png')

        #FIXME: TEMPORARY
        MainWindow.setWindowFlags(QtCore.Qt.FramelessWindowHint)

        #Aquest codi d'aqui crea els elements necessaris per a crear
        #un graf. Pots indicar el tipus de graf (simple o dirigit) i
        #assignar un pes a l'aresta
        """
        self.cb = QtWidgets.QComboBox(self.centralwidget)
        self.cb.setGeometry(QtCore.QRect(1040, 24, 75, 23))
        self.cb.addItems(["Simple", "Dirigit"])

        self.textEdit = QtWidgets.QTextEdit(self.centralwidget)
        self.textEdit.setGeometry(QtCore.QRect(1040, 0, 75, 23))
        self.textEdit.setObjectName("textEdit")
        """

        self.originLabel = QtWidgets.QLabel(self.centralwidget)
        self.originLabel.setGeometry(QtCore.QRect(1040, 0, 75, 23))
        self.originLabel.setText("Origen")
        self.originLabel.setObjectName("originLabel")

        self.originLat = QtWidgets.QLineEdit(self.centralwidget)
        self.originLat.setGeometry(QtCore.QRect(1040, 24, 75, 23))
        self.originLat.setPlaceholderText("Latitud")

        self.originLon = QtWidgets.QLineEdit(self.centralwidget)
        self.originLon.setGeometry(QtCore.QRect(1116, 24, 75, 23))
        self.originLon.setPlaceholderText("Longitud")

        self.goalLabel = QtWidgets.QLabel(self.centralwidget)
        self.goalLabel.setGeometry(QtCore.QRect(1040, 48, 75, 23))
        self.goalLabel.setText("Destí")
        self.goalLabel.setObjectName("goalLabel")

        self.goalLat = QtWidgets.QLineEdit(self.centralwidget)
        self.goalLat.setGeometry(QtCore.QRect(1040, 72, 75, 23))
        self.goalLat.setPlaceholderText("Latitud")

        self.goalLon = QtWidgets.QLineEdit(self.centralwidget)
        self.goalLon.setGeometry(QtCore.QRect(1116, 72, 75, 23))
        self.goalLon.setPlaceholderText("Longitud")

        self.calculateButton = QtWidgets.QPushButton(self.centralwidget)
        self.calculateButton.setGeometry(QtCore.QRect(1040, 96, 75, 23))
        self.calculateButton.setObjectName("CalculateButton")
        self.calculateButton.setText("Calcular")
        self.calculateButton.clicked.connect(self.calculate_route)

        #Indicador per al desti
        self.pinLabel = QtWidgets.QLabel(self.centralwidget)
        self.pinLabel.setScaledContents(True)
        self.pinLabel.setGeometry(QtCore.QRect(0,0,16,26))
        self.pinLabel.setText("")
        self.pinLabel.setObjectName("pinLabel")
        self.pinLabel.setPixmap(QtGui.QPixmap("assets/marcador.png"))
        self.pinLabel.hide()

        #Indicador per a l'origen

        self.resetButton = QtWidgets.QPushButton(self.centralwidget)
        self.resetButton.setGeometry(QtCore.QRect(1116, 96, 23, 23))
        self.resetButton.setObjectName("ResetButton")
        self.resetButton.setText("R")
        self.resetButton.clicked.connect(self.reset_route)

        #"""     

        #self.firstBtn = 0
        self.firstClick = True

        self.originVertex = 0
        self.goalVertex = 0

        self.g = Graph()
        self.g_val = list(self.g.vertex_coord.values())


    def retranslateUi(self, MainWindow):
        _translate = QtCore.QCoreApplication.translate
        MainWindow.setWindowTitle(_translate("MainWindow", "MainWindow"))

    #Aquesta funció et permet marcar les interseccions (vertex del graf) al mapa
    #i ho escriu a un archiu .csv per a que després el programa 'metaprogram.py'
    #et doni el codi per els botons i les seves funcions. Aquests t'ajudaran a indicar
    #arestes i els seus pesos
    def mouseReleased(self, QMouseEvent):
        """
        f = open("vertexs.csv", "a")
        f.write(f"{QMouseEvent.x()},{QMouseEvent.y()}\n")
        f.close()

        p = MapPainter('test_map.png')
        p.paint_points(pos=(QMouseEvent.x(),QMouseEvent.y()),r=10)
        self.label.setPixmap(QtGui.QPixmap("test_map.png"))
        """
        cv = self.g.find_closest((np.int64(QMouseEvent.x()), np.int64(QMouseEvent.y())))
        x = self.g.vertex_coord[cv][0]
        y = self.g.vertex_coord[cv][1]

        oLat, oLon = self.map_painter.img_to_coord(x,y)

        w = self.pinLabel.geometry().width()
        h = self.pinLabel.geometry().height()

        if self.firstClick:
            self.originLat.setText(f"{round(oLat,4)}")
            self.originLon.setText(f"{round(oLon,4)}")
            self.firstClick = False
            self.originVertex = cv
        else:
            self.pinLabel.move(x-(w/2.0),y-h)
            self.pinLabel.show()

            self.goalLat.setText(f"{round(oLat,4)}")
            self.goalLon.setText(f"{round(oLon,4)}")
            self.firstClick = True
            self.goalVertex = cv
        #"""

    def reset_route(self):
        self.label.setPixmap(QtGui.QPixmap('assets/map.png'))
        self.pinLabel.hide()
        
        self.originLat.setText("")
        self.originLon.setText("")
        self.goalLat.setText("")
        self.goalLon.setText("")

        self.firstClick = True
        self.originVertex = 0
        self.goalVertex = 0

        self.map_painter.set_map('assets/map.png')

    def calculate_route(self):
        if self.originVertex == 0 or self.goalVertex == 0:
            return

        originVertex = self.originVertex
        goalVertex = self.goalVertex

        route = A_Star(self.g, originVertex, goalVertex)

        if route:
            self.map_painter.set_route(self.g.route_to_coords(route))
            self.map_painter.paint_map('assets/result_map.png')
            self.label.setPixmap(QtGui.QPixmap('assets/result_map.png'))

        else:
            print("There's no route")
